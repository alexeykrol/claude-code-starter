#!/bin/bash
#
# Claude Code Starter Framework â€” Installation Script
# Version: 2.1.0
#
# This script installs the framework into new or existing projects.
# It handles both clean installations and migrations from old versions.
#

set -e  # Exit on error

VERSION="2.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# Output Functions
# ============================================================================

log_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

log_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

log_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# ============================================================================
# Detection Functions
# ============================================================================

detect_project_type() {
    if [ -f "package.json" ] || [ -d "src" ] || [ -f "README.md" ] || [ -d ".git" ]; then
        echo "legacy"
    else
        echo "new"
    fi
}

detect_old_framework() {
    local OLD_VERSION=""

    # Check for CLAUDE.md in root or .claude/
    if [ -f "CLAUDE.md" ] && grep -q "Claude Code Starter" CLAUDE.md 2>/dev/null; then
        OLD_VERSION=$(grep -o "v[0-9]\+\.[0-9]\+\.[0-9]\+" CLAUDE.md | head -1)
    elif [ -f ".claude/CLAUDE.md" ] && grep -q "Claude Code Starter" .claude/CLAUDE.md 2>/dev/null; then
        OLD_VERSION=$(grep -o "v[0-9]\+\.[0-9]\+\.[0-9]\+" .claude/CLAUDE.md | head -1)
    fi

    if [ -n "$OLD_VERSION" ]; then
        echo "$OLD_VERSION"
    else
        echo "none"
    fi
}

check_git() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        return 1
    fi
    return 0
}

# ============================================================================
# Backup Functions
# ============================================================================

backup_old_framework() {
    local BACKUP_DIR=".claude/.backup-$(date +%Y%m%d-%H%M%S)"

    log_info "Creating backup of old framework files..."
    mkdir -p "$BACKUP_DIR"

    # Backup CLAUDE.md if exists
    [ -f "CLAUDE.md" ] && cp CLAUDE.md "$BACKUP_DIR/"

    # Backup .claude/ contents if exists
    if [ -d ".claude" ]; then
        # Copy everything except the backup directory itself
        find .claude -maxdepth 1 -mindepth 1 ! -name '.backup-*' -exec cp -r {} "$BACKUP_DIR/" \;
    fi

    log_success "Backup created: $BACKUP_DIR"

    # Commit backup to git
    if check_git; then
        git add "$BACKUP_DIR"
        git commit -m "backup: Save old framework before migration to v${VERSION}

- Backup location: $BACKUP_DIR
- Can be restored with: git checkout HEAD~1 -- $BACKUP_DIR

ðŸ¤– Generated by Claude Code Starter migration" || log_warning "Failed to commit backup (might be nothing to commit)"

        log_success "Backup committed to git"
    else
        log_warning "Not a git repository - backup not committed"
    fi

    echo "$BACKUP_DIR"
}

# ============================================================================
# Installation Functions
# ============================================================================

install_framework_files() {
    log_info "Installing framework files..."

    # Extract framework bundle
    if [ -f "$SCRIPT_DIR/framework-bundle.tar.gz" ]; then
        tar -xzf "$SCRIPT_DIR/framework-bundle.tar.gz" -C /tmp/

        # Copy CLAUDE.md to root
        cp /tmp/framework-bundle/CLAUDE.md ./
        log_success "Installed CLAUDE.md"

        # Copy FRAMEWORK_GUIDE.md to root
        cp /tmp/framework-bundle/FRAMEWORK_GUIDE.md ./
        log_success "Installed FRAMEWORK_GUIDE.md"

        # Copy .claude/ directory
        mkdir -p .claude
        cp -r /tmp/framework-bundle/.claude/* .claude/
        log_success "Installed .claude/ directory"

        # Cleanup
        rm -rf /tmp/framework-bundle
    else
        log_error "framework-bundle.tar.gz not found!"
        log_info "Make sure you extracted the full distribution package."
        exit 1
    fi
}

generate_meta_files_new() {
    log_info "Generating meta files for new project..."

    local PROJECT_NAME=$(basename "$PROJECT_DIR")
    local DATE=$(date +%Y-%m-%d)
    local BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

    # Generate SNAPSHOT.md
    sed -e "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" \
        -e "s/{{DATE}}/$DATE/g" \
        -e "s/{{PROJECT_VERSION}}/0.1.0/g" \
        -e "s/{{CURRENT_BRANCH}}/$BRANCH/g" \
        -e "s/{{PROJECT_DESCRIPTION}}/A new project using Claude Code Starter Framework/g" \
        -e "s/{{TECH_STACK}}/- Add your tech stack here/g" \
        -e "s/{{PROJECT_STRUCTURE}}/â”œâ”€â”€ Add your structure here/g" \
        -e "s/{{PROJECT_KEY_CONCEPTS}}/Add key concepts about your project here/g" \
        .claude/templates/SNAPSHOT.template.md > .claude/SNAPSHOT.md

    # Generate BACKLOG.md
    sed -e "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" \
        -e "s/{{DATE}}/$DATE/g" \
        .claude/templates/BACKLOG.template.md > .claude/BACKLOG.md

    # Generate ARCHITECTURE.md
    sed -e "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" \
        -e "s/{{PROJECT_DESCRIPTION}}/A new project/g" \
        -e "s/{{TECH_STACK}}/- Add your tech stack/g" \
        -e "s/{{PROJECT_STRUCTURE}}/â”œâ”€â”€ Add structure/g" \
        -e "s/{{COMPONENT_1_NAME}}/Main Component/g" \
        -e "s/{{COMPONENT_1_PATH}}/.\/src/g" \
        -e "s/{{COMPONENT_1_PURPOSE}}/Main application code/g" \
        -e "s/{{COMPONENT_2_NAME}}/Configuration/g" \
        -e "s/{{COMPONENT_2_PATH}}/.\/config/g" \
        -e "s/{{COMPONENT_2_PURPOSE}}/Project configuration/g" \
        -e "s/{{ARCHITECTURE_PATTERN}}/MVC \/ Component-based/g" \
        -e "s/{{PATTERN_DESCRIPTION}}/Describe your architecture pattern/g" \
        -e "s/{{DATA_FLOW_DIAGRAM}}/Add your data flow diagram/g" \
        -e "s/{{DEPENDENCIES_LIST}}/List your dependencies/g" \
        -e "s/{{ENV_CONFIG}}/Add environment configuration/g" \
        -e "s/{{BUILD_CONFIG}}/Add build configuration/g" \
        -e "s/{{TESTING_STRATEGY}}/Add testing strategy/g" \
        -e "s/{{DEPLOYMENT_INFO}}/Add deployment info/g" \
        .claude/templates/ARCHITECTURE.template.md > .claude/ARCHITECTURE.md

    log_success "Generated meta files (edit them to customize)"
}

generate_meta_files_legacy() {
    log_info "Analyzing project and generating meta files..."

    local PROJECT_NAME=$(basename "$PROJECT_DIR")
    local DATE=$(date +%Y-%m-%d)
    local BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

    # Try to extract info from package.json
    local PROJECT_VERSION="1.0.0"
    local PROJECT_DESCRIPTION="Existing project migrated to Claude Code Starter Framework"

    if [ -f "package.json" ]; then
        if command -v jq &> /dev/null; then
            PROJECT_VERSION=$(jq -r '.version // "1.0.0"' package.json)
            PROJECT_DESCRIPTION=$(jq -r '.description // "Existing project"' package.json)
        fi
    fi

    # Try to extract from README.md
    if [ -f "README.md" ]; then
        # Get first paragraph as description
        local README_DESC=$(sed -n '/^[^#]/p' README.md | head -1)
        [ -n "$README_DESC" ] && PROJECT_DESCRIPTION="$README_DESC"
    fi

    # Analyze project structure
    local TECH_STACK=""
    [ -f "package.json" ] && TECH_STACK="$TECH_STACK\n- Node.js/JavaScript"
    [ -f "requirements.txt" ] && TECH_STACK="$TECH_STACK\n- Python"
    [ -f "go.mod" ] && TECH_STACK="$TECH_STACK\n- Go"
    [ -f "Cargo.toml" ] && TECH_STACK="$TECH_STACK\n- Rust"
    [ -z "$TECH_STACK" ] && TECH_STACK="\n- Unknown (please update)"

    # Generate file structure
    local PROJECT_STRUCTURE=$(tree -L 2 -I 'node_modules|.git|dist|build' --charset ascii 2>/dev/null || ls -la | awk '{print $NF}' | grep -v "^total" | sed 's/^/â”œâ”€â”€ /')

    # Generate SNAPSHOT.md with project data
    sed -e "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" \
        -e "s/{{DATE}}/$DATE/g" \
        -e "s/{{PROJECT_VERSION}}/$PROJECT_VERSION/g" \
        -e "s/{{CURRENT_BRANCH}}/$BRANCH/g" \
        -e "s/{{PROJECT_DESCRIPTION}}/$PROJECT_DESCRIPTION/g" \
        .claude/templates/SNAPSHOT.template.md > .claude/SNAPSHOT.md

    # Insert extracted tech stack
    sed -i.bak "s|{{TECH_STACK}}|$TECH_STACK|g" .claude/SNAPSHOT.md
    sed -i.bak "s|{{PROJECT_STRUCTURE}}|$PROJECT_STRUCTURE|g" .claude/SNAPSHOT.md
    sed -i.bak "s|{{PROJECT_KEY_CONCEPTS}}|Extracted from existing project. Please review and update.|g" .claude/SNAPSHOT.md
    rm -f .claude/SNAPSHOT.md.bak

    # Generate BACKLOG.md
    sed -e "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" \
        -e "s/{{DATE}}/$DATE/g" \
        .claude/templates/BACKLOG.template.md > .claude/BACKLOG.md

    # Try to extract TODOs from code
    if command -v rg &> /dev/null; then
        log_info "Extracting TODOs from code..."
        rg "TODO|FIXME|XXX" -g '!{node_modules,dist,build}' --no-heading 2>/dev/null | head -10 | while read -r line; do
            echo "- [ ] $line" >> .claude/BACKLOG.md
        done
    fi

    # Generate ARCHITECTURE.md with project analysis
    sed -e "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" \
        -e "s/{{PROJECT_DESCRIPTION}}/$PROJECT_DESCRIPTION/g" \
        .claude/templates/ARCHITECTURE.template.md > .claude/ARCHITECTURE.md

    sed -i.bak "s|{{TECH_STACK}}|$TECH_STACK|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{PROJECT_STRUCTURE}}|$PROJECT_STRUCTURE|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{COMPONENT_1_NAME}}|Main Application|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{COMPONENT_1_PATH}}|./src|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{COMPONENT_1_PURPOSE}}|Core application code|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{COMPONENT_2_NAME}}|Configuration|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{COMPONENT_2_PATH}}|./config|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{COMPONENT_2_PURPOSE}}|Project configuration|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{ARCHITECTURE_PATTERN}}|See existing code|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{PATTERN_DESCRIPTION}}|Analyzed from existing project|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{DATA_FLOW_DIAGRAM}}|See existing documentation|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{DEPENDENCIES_LIST}}|See package.json or requirements.txt|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{ENV_CONFIG}}|See existing configuration files|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{BUILD_CONFIG}}|See existing build scripts|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{TESTING_STRATEGY}}|See existing tests|g" .claude/ARCHITECTURE.md
    sed -i.bak "s|{{DEPLOYMENT_INFO}}|See existing deployment configuration|g" .claude/ARCHITECTURE.md
    rm -f .claude/ARCHITECTURE.md.bak

    log_success "Generated meta files from project analysis"
}

update_readme() {
    log_info "Updating README.md..."

    if [ -f "README.md" ]; then
        # Check if framework link already exists
        if ! grep -q "Claude Code Starter Framework" README.md; then
            # Create backup
            cp README.md README.md.backup

            # Add framework link after first heading
            awk '/^# / && !x {print; print ""; print "> ðŸ¤– **AI Development:** This project uses [Claude Code Starter Framework](./FRAMEWORK_GUIDE.md). See [usage guide](./FRAMEWORK_GUIDE.md) for details."; print ""; x=1; next} 1' README.md.backup > README.md

            rm README.md.backup
            log_success "Added framework link to README.md"
        else
            log_info "README.md already has framework link"
        fi
    else
        # Create minimal README
        cat > README.md <<EOF
# $(basename "$PROJECT_DIR")

> ðŸ¤– **AI Development:** This project uses [Claude Code Starter Framework](./FRAMEWORK_GUIDE.md).

## About

Add your project description here.

## Getting Started

Add getting started instructions here.
EOF
        log_success "Created README.md with framework link"
    fi
}

setup_gitignore() {
    log_info "Setting up .gitignore..."

    if [ ! -f ".gitignore" ]; then
        touch .gitignore
    fi

    # Add framework-specific ignores
    local IGNORES=(
        "dialog/"
        "html-viewer/"
        ".claude/.last_session"
        ".claude/.backup-*"
    )

    for ignore in "${IGNORES[@]}"; do
        if ! grep -q "^$ignore" .gitignore 2>/dev/null; then
            echo "$ignore" >> .gitignore
        fi
    done

    log_success "Updated .gitignore"
}

# ============================================================================
# Main Installation Flow
# ============================================================================

main() {
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Claude Code Starter Framework â€” Installation"
    echo "  Version: $VERSION"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Check git
    if ! check_git; then
        log_error "This is not a git repository!"
        log_info "Initialize git first:"
        echo "  git init"
        echo "  git add ."
        echo "  git commit -m \"Initial commit\""
        exit 1
    fi

    # Detect project type
    local PROJECT_TYPE=$(detect_project_type)
    log_info "Project type: $PROJECT_TYPE"

    # Detect old framework
    local OLD_FW=$(detect_old_framework)

    if [ "$OLD_FW" != "none" ]; then
        log_warning "Detected old framework: $OLD_FW"
        log_info "Starting migration process..."

        # Backup old framework
        local BACKUP_DIR=$(backup_old_framework)

        # Remove old framework files (they're backed up)
        log_info "Removing old framework files..."
        rm -rf .claude/commands .claude/dist
        [ -f "CLAUDE.md" ] && rm CLAUDE.md

        # Install new framework
        install_framework_files

        # Generate meta files with legacy analysis
        generate_meta_files_legacy

        # Create migration report
        cat > .claude/MIGRATION_REPORT.md <<EOF
# Framework Migration Report

**Date:** $(date +%Y-%m-%d)
**From:** $OLD_FW
**To:** v$VERSION

## Backup Location

Your old framework files are saved in:
\`$BACKUP_DIR\`

And committed to git history.

## What Was Migrated

âœ… Project context extracted from existing files
âœ… TODOs extracted from code comments
âœ… Project structure analyzed and documented

## Rollback

To rollback this migration:

\`\`\`bash
# Full rollback
git reset --hard HEAD~2

# Restore specific file
git checkout HEAD~1 -- .claude/SNAPSHOT.md
\`\`\`

## Next Steps

1. Review \`.claude/SNAPSHOT.md\` and update project context
2. Review \`.claude/BACKLOG.md\` and organize tasks
3. Review \`.claude/ARCHITECTURE.md\` and update architecture notes
4. See \`FRAMEWORK_GUIDE.md\` for usage instructions

---
ðŸ¤– Generated by Claude Code Starter v$VERSION
EOF

        log_success "Created migration report: .claude/MIGRATION_REPORT.md"

    else
        # Clean installation
        log_info "Performing clean installation..."

        # Install framework files
        install_framework_files

        # Generate meta files
        if [ "$PROJECT_TYPE" = "new" ]; then
            generate_meta_files_new
        else
            generate_meta_files_legacy
        fi
    fi

    # Update README
    update_readme

    # Setup .gitignore
    setup_gitignore

    # Final commit
    log_info "Creating installation commit..."
    git add -A
    git commit -m "chore: Install Claude Code Starter Framework v$VERSION

- Framework files installed in .claude/
- Meta files generated (SNAPSHOT, BACKLOG, ARCHITECTURE)
- README updated with framework link
- See FRAMEWORK_GUIDE.md for usage

ðŸ¤– Generated by Claude Code Starter v$VERSION" || log_warning "Nothing to commit (already up to date)"

    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log_success "Installation complete!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Next steps:"
    echo ""
    echo "  1. Open this project in Claude Code"
    echo "  2. Type: start (or Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ)"
    echo "  3. Claude will load your project context"
    echo ""
    echo "Documentation:"
    echo "  - FRAMEWORK_GUIDE.md â€” How to use the framework"
    echo "  - .claude/SNAPSHOT.md â€” Edit to update project context"
    echo "  - .claude/BACKLOG.md â€” Edit to manage tasks"
    echo ""

    if [ "$OLD_FW" != "none" ]; then
        echo "Migration:"
        echo "  - .claude/MIGRATION_REPORT.md â€” Migration details"
        echo "  - $BACKUP_DIR â€” Old files backup"
        echo ""
    fi
}

# Run main function
main "$@"
